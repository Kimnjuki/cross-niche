import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  AlertTriangle,
  Shield,
  Code,
  ExternalLink,
  Download,
  Copy,
  CheckCircle2,
  XCircle,
  Clock,
  TrendingUp
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { useState } from 'react';
import type { VulnerabilityReport } from '@/types';

interface VulnerabilityGuideProps {
  vulnerability: VulnerabilityReport;
  className?: string;
}

/**
 * Threatpost-style vulnerability guide component
 * Features: CVE details, CVSS scoring, step-by-step remediation, PoC info
 */
export function VulnerabilityGuide({ vulnerability, className }: VulnerabilityGuideProps) {
  const [copied, setCopied] = useState(false);

  const severityConfig = {
    critical: { color: 'text-red-500', bg: 'bg-red-500/10', border: 'border-red-500/20', label: 'Critical' },
    high: { color: 'text-orange-500', bg: 'bg-orange-500/10', border: 'border-orange-500/20', label: 'High' },
    medium: { color: 'text-yellow-500', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20', label: 'Medium' },
    low: { color: 'text-blue-500', bg: 'bg-blue-500/10', border: 'border-blue-500/20', label: 'Low' }
  };

  const statusConfig = {
    unpatched: { color: 'text-red-500', bg: 'bg-red-500/10', label: 'Unpatched' },
    patched: { color: 'text-green-500', bg: 'bg-green-500/10', label: 'Patched' },
    disputed: { color: 'text-yellow-500', bg: 'bg-yellow-500/10', label: 'Disputed' },
    rejected: { color: 'text-gray-500', bg: 'bg-gray-500/10', label: 'Rejected' }
  };

  const severity = severityConfig[vulnerability.severity];
  const status = statusConfig[vulnerability.status];

  const copyCVE = () => {
    navigator.clipboard.writeText(vulnerability.cve);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className={cn('space-y-6', className)}>
      {/* Header Alert */}
      <Alert className={cn('border-2', severity.border, severity.bg)}>
        <AlertTriangle className={cn('h-5 w-5', severity.color)} />
        <AlertTitle className={cn('text-xl font-bold mb-2', severity.color)}>
          {severity.label} Vulnerability: {vulnerability.cve}
        </AlertTitle>
        <AlertDescription>
          <div className="flex items-center gap-4 mt-2">
            <Badge className={cn(severity.color, 'bg-transparent border-current')}>
              CVSS {vulnerability.cvssScore.toFixed(1)}
            </Badge>
            <Badge className={cn(status.color, 'bg-transparent border-current')}>
              {status.label}
            </Badge>
            <button
              onClick={copyCVE}
              className="flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors"
            >
              {copied ? (
                <>
                  <CheckCircle2 className="h-4 w-4 text-green-500" />
                  Copied!
                </>
              ) : (
                <>
                  <Copy className="h-4 w-4" />
                  Copy CVE
                </>
              )}
            </button>
          </div>
        </AlertDescription>
      </Alert>

      {/* CVE Header */}
      <Card>
        <CardHeader>
          <div className="flex items-start justify-between">
            <div className="flex-1">
              <CardTitle className="text-2xl mb-2">{vulnerability.title}</CardTitle>
              <div className="flex items-center gap-2 mb-4">
                <code className="text-lg font-mono bg-muted px-3 py-1 rounded">
                  {vulnerability.cve}
                </code>
                <Badge variant="outline">CVSS {vulnerability.cvssScore.toFixed(1)}</Badge>
              </div>
            </div>
            <div className="text-right">
              <div className="text-3xl font-bold mb-1" style={{ color: severity.color.replace('text-', '') }}>
                {vulnerability.cvssScore.toFixed(1)}
              </div>
              <div className="text-sm text-muted-foreground">CVSS Score</div>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <p className="text-lg leading-relaxed">{vulnerability.description}</p>
        </CardContent>
      </Card>

      {/* Affected Products */}
      <Card>
        <CardHeader>
          <CardTitle>Affected Products</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {vulnerability.affectedProducts.map((product, idx) => (
              <div key={idx} className="p-4 border rounded-lg">
                <div className="font-semibold mb-1">{product.vendor} {product.product}</div>
                <div className="text-sm text-muted-foreground">
                  Affected Versions: <code className="bg-muted px-2 py-1 rounded">{product.versions}</code>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Detailed Analysis Tabs */}
      <Tabs defaultValue="exploitability" className="w-full">
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="exploitability">Exploitability</TabsTrigger>
          <TabsTrigger value="impact">Impact</TabsTrigger>
          <TabsTrigger value="remediation">Remediation</TabsTrigger>
        </TabsList>

        <TabsContent value="exploitability" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Code className="h-5 w-5" />
                Exploitability Analysis
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="prose prose-sm max-w-none dark:prose-invert">
                <div dangerouslySetInnerHTML={{ __html: vulnerability.exploitability }} />
              </div>
              {vulnerability.proofOfConcept && (
                <Alert className="mt-4 bg-yellow-500/5 border-yellow-500/20">
                  <AlertTriangle className="h-4 w-4 text-yellow-500" />
                  <AlertTitle>Proof of Concept Available</AlertTitle>
                  <AlertDescription className="mt-2">
                    <p className="text-sm mb-2">{vulnerability.proofOfConcept}</p>
                    <Button variant="outline" size="sm" asChild>
                      <a href="#" target="_blank" rel="noopener noreferrer">
                        View PoC <ExternalLink className="h-3 w-3 ml-1" />
                      </a>
                    </Button>
                  </AlertDescription>
                </Alert>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="impact" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingUp className="h-5 w-5" />
                Impact Analysis
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="prose prose-sm max-w-none dark:prose-invert">
                <div dangerouslySetInnerHTML={{ __html: vulnerability.impact }} />
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="remediation" className="mt-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Shield className="h-5 w-5" />
                Remediation Guide
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="prose prose-sm max-w-none dark:prose-invert">
                <div dangerouslySetInnerHTML={{ __html: vulnerability.remediation }} />
              </div>
              
              {/* Quick Action Steps */}
              <div className="mt-6 p-4 bg-muted rounded-lg">
                <div className="font-semibold mb-3">Quick Remediation Steps</div>
                <ol className="space-y-2 list-decimal list-inside">
                  <li>Identify all affected systems using the product list above</li>
                  <li>Check vendor advisories for patch availability</li>
                  <li>Apply patches immediately if available</li>
                  <li>If no patch available, implement temporary mitigations</li>
                  <li>Monitor systems for exploitation attempts</li>
                </ol>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Status & Timeline */}
      <div className="grid md:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>Vulnerability Status</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-3 mb-4">
              {vulnerability.status === 'patched' ? (
                <CheckCircle2 className="h-8 w-8 text-green-500" />
              ) : (
                <XCircle className="h-8 w-8 text-red-500" />
              )}
              <div>
                <div className="font-semibold text-lg">{status.label}</div>
                <div className="text-sm text-muted-foreground">
                  {vulnerability.status === 'patched' 
                    ? 'Patches are available' 
                    : 'No patches available yet'}
                </div>
              </div>
            </div>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-muted-foreground">Published</span>
                <span>{new Date(vulnerability.publishedAt).toLocaleDateString()}</span>
              </div>
              {vulnerability.updatedAt && (
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Last Updated</span>
                  <span>{new Date(vulnerability.updatedAt).toLocaleDateString()}</span>
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>References</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-2">
              {vulnerability.references.map((ref, idx) => (
                <a
                  key={idx}
                  href={ref.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center justify-between p-2 border rounded hover:bg-muted transition-colors group"
                >
                  <div className="flex items-center gap-2">
                    <Badge variant="outline" className="text-xs">
                      {ref.type}
                    </Badge>
                    <span className="text-sm group-hover:text-primary transition-colors">
                      {ref.title}
                    </span>
                  </div>
                  <ExternalLink className="h-4 w-4 text-muted-foreground group-hover:text-primary transition-colors" />
                </a>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Actions */}
      <div className="flex gap-4">
        <Button className="flex-1">
          <Download className="h-4 w-4 mr-2" />
          Download Full Report
        </Button>
        <Button variant="outline">
          <ExternalLink className="h-4 w-4 mr-2" />
          View CVE Details
        </Button>
      </div>
    </div>
  );
}

